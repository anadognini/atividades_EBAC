# -*- coding: utf-8 -*-
"""qualidade_do_modelo.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1a120Zs9gzetGRUBiseysoFsF8a3tehCg
"""

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import statsmodels.formula.api as smf

titanic = sns.load_dataset('titanic')
titanic.head()

reglog = smf.logit("survived ~ sex + C(pclass) + fare", data=titanic).fit()
reglog.summary()

titanic['predito'] = reglog.predict(titanic)
titanic.head()

"""### Calibragem"""

cat_pred = pd.qcut(titanic['predito'], 5, duplicates='drop')
cat_pred.value_counts().sort_index()

group_reg = titanic.groupby(cat_pred)

qualid = group_reg[['survived']].count().rename(columns={'survived': "contagem"})
qualid

qualid['media_predito'] = group_reg['predito'].mean()
qualid

qualid['pct_sobreviventes'] = group_reg['survived'].mean()
qualid

fig = plt.figure()
ax = fig.add_subplot(1, 1, 1)

ax = qualid['pct_sobreviventes'].plot(label='% Predito')
ax = qualid['media_predito'].plot(label='% Observado')

ticks = ax.set_xticks([0, 1, 2, 3, 4])
labels = ax.set_xticklabels([1, 2, 3, 4, 5])
ax.legend(loc='lower right')
ax.set_ylabel('Probabilidade de Evento')
ax.set_xlabel('Grupo')

"""### Discriminação

#### Curva ROC
"""

from sklearn.metrics import roc_curve
from sklearn import metrics

fpr, tpr, thresholds = metrics.roc_curve(titanic['survived'], titanic['predito'])

plt.figure()
lw = 2

fpr, tpr, thresholds = metrics.roc_curve(titanic['survived'], titanic['predito'])
auc_ = metrics.auc(fpr, tpr)

plt.plot(fpr, tpr, color='darkorange', lw=lw, label='Roc Curve (area= %0.2f)' % auc_)
plt.plot([0, 1], [0, 1], color='navy', lw=lw, linestyle='--')
plt.xlim([0.0, 1.0])
plt.ylim([0.0, 1.05])
plt.xlabel('False Positive Rate')
plt.ylabel('True Positive Rate')
plt.title('Receiver operating characteristic example')
plt.legend(loc="lower right")
plt.show()

"""#### Gráfico do KS"""

fig = plt.figure()
ax = fig.add_subplot(1, 1, 1)

score_pop1 = titanic.loc[titanic['survived']==1, 'predito']
ax.plot(np.sort(score_pop1), np.linspace(0, 1, len(score_pop1), endpoint=False), label="Sobreviventes")

score_pop2 = titanic.loc[titanic['survived']!=1, 'predito']
ax.plot(np.sort(score_pop2), np.linspace(0, 1, len(score_pop2), endpoint=False), label="Não sobreviventes")

ax.set_xlabel('P')
ax.set_ylabel('Função Distribuição Acumulada')

"""#### Indicadores"""

from sklearn import metrics
from scipy.stats import ks_2samp

acc = metrics.accuracy_score(titanic['survived'], titanic['predito']==0.5)
print("Acurácia: {0:.2f}%".format(acc*100))

# AUC
fpr, tpr, thresholds = metrics.roc_curve(titanic['survived'], titanic['predito'])
auc_ = metrics.auc(fpr, tpr)

# Gini
gini = 2 * auc_ - 1

# KS
ks = ks_2samp(titanic.loc[titanic['survived'] == 1, 'predito'], titanic.loc[titanic['survived'] != 1, 'predito']).statistic

print('KS: {0:.2f}% \nAUC: {1:.2f}% \nGini: {2:.2f}%'.format(ks*100, auc_*100, gini*100))